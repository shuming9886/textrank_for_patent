CN108920331A
一种计算机硬件配置变动的报警方法

一种计算机硬件配置变动的报警方法，在关机状态下侦测系统硬件变动，包括有电源和没有电源两种关机状态；硬件配置变动后，硬件触发中断，由BIOS SMI程序获取平台配置信息，由BMC完成配置信息的存储及差异化显示，三者配合完成将平台配置信息及时准确记录在平台本体上；硬件信息变动后，BIOS可以根据需求，灵活多样设置操作路径，可设置为无操作，或者显示警告信息再继续运行，或者暂停系统待管理员确认安全后再继续运行；BMC存储信息进入EEPROM，断电后信息依然能保存不消失，BMC显示界面为研发人员、测试人员、客户提供了统一的信息平台，提高了沟通效率，两次配置差异化显示，能提醒客户硬件变动点。

权利要求书
1.一种计算机硬件配置变动的报警方法，其特征在于，包括以下步骤：
A.检测步骤：所述检测步骤系配置电路检测主板配置是否发生改变，若否则不进行操作；若是则发送电信号给BIOS；所述配置电路设置在主板上并将主板配置发生变化转化为电信号；
B.读取步骤：所述读取步骤系BIOS接收到所述配置电路传送的电信号后读取主板配置信息；
C.存储步骤：所述存储步骤系所述BIOS将读取的主板配置信息传送给BMC并存入所述BMC的EEPROM中；
D.比较步骤：所述比较步骤系所述BMC读取所述EEPROM中最近两组主板配置信息并将发生改变的配置信息标识出来。

说明书
一种计算机硬件配置变动的报警方法
技术领域
本发明涉及计算机领域，尤其涉及一种计算机硬件配置变动的报警方法。
背景技术
服务器主板在研发过程中，要经过大量的兼容性测试，需要由各种型号的CPU、内存、不同的外接卡等组成各种配置的平台系统，然后进行长时间的稳定性、压力等测试，测试人员要对平台配置信息进行记录，一旦出现测试问题，以方便追溯，供给研发人员进行分析。
服务器在终端客户正式投入使用前也会进行大量测试，投入使用后也会人为增加或者减少扩展卡，这些服务器配置信息改变情况也需要被记录，一旦服务器出现不稳定情况，方便系统管理员快速分析问题。
然而，在目前的测试过程中，测试机台和机台配置信息记录是分开的，这就导致配置信息容易遗失或者不同机台之间混淆。其他人员测试或用户使用过程中改变了平台的硬件配置有可能不会被记录，不同人员对机台配置信息的获取，也没有统一的信息接口，而是要进行反复沟通确认等，这些因素无疑增加了沟通成本，加大了追溯的难度及获取信息的准确性，降低了测试的有效性。
一旦扩展配置导致系统不稳定，系统管理员排查错误将降低很多效率。服务器里面已经存在的扩展卡，一旦损坏无法使用，也需要及时通过技术手段通知系统管理员，或移除或更换，避免坏卡造成系统的不稳定。这种硬件配置信息的记录，可能并不会被人重视，有可能不被记录，或者由于专业水平原因而记录不全面，系统出现故障时，不能给分析人员快速提供有效信息数据。这些都会降低工作效率。
所以需要一种当硬件配置发生改变之后将改变报告相关人员的主板或方法，从而提高计算机维护人员的工作效率。
发明内容
本发明的目的在于提供一种计算机硬件配置变动的报警方法，旨在解决现有计算机主板配置发生变动后无法主动报告的问题。
本发明是这样实现的：一种计算机硬件配置变动的报警方法，包括以下步骤：
A.检测步骤：所述检测步骤系配置电路检测主板配置是否发生改变，若否则不进行操作；若是则发送电信号给BIOS；所述配置电路设置在主板上并将主板配置发生变化转化为电信号； BIOS(Basic Input Output System)是指基本输入输出系统，主要用于计算机开机过程中各种硬件设备的初始化和检测
B.读取步骤：所述读取步骤系BIOS接收到所述配置电路传送的电信号后读取主板配置信息；
C.存储步骤：所述存储步骤系所述BIOS将读取的主板配置信息传送给BMC并存入所述BMC的EEPROM中；BMC（Baseboard Management Controller）是指基板管理控制器。一般内置在主板上，支持行业标准的 IPMI 规范。BMC提供的功能包括：本地和远程诊断、控制台支持、配置管理、硬件管理和故障排除。
D.比较步骤：所述比较步骤系所述BMC读取所述EEPROM中最近两组主板配置信息并将发生改变的配置信息标识出来。EEPROM是一种非易失性存储介质，是BMC的主要储存介质。
本发明的进一步技术方案是：所述配置电路检测到CPU插座和PCIE插槽的在位信号的电平发生变化后发送电信号给BIOS。
本发明的进一步技术方案是：所述配置电路还包括待机电源，所述待机电源与所述CPU插座和PCIE插槽之间通过电阻R1相连；所述CPU插座和PCIE插槽通过电阻R2接地；所述R2的阻值为R1阻值的5倍以上。
本发明的进一步技术方案是：所述配置电路还包括实时时钟电源，所述实时时钟电源与所述CPU插座和PCIE插槽之间通过电阻R1相连。实时时钟电源简称RTC电源，其电压为3.3V，与待机电源电压相同，同时连接两个电源保证了整个系统的可靠性，一般情况下通过待机电源为系统供电，停电或发生其他特殊情况时通过RTC电源供电。
本发明的进一步技术方案是：所述配置电路包括与所述CPU插座和PCIE插槽相连的单稳态施密特电路。单稳态施密特电路是将单稳态电路和施密特电路结合起来获得的电路。单稳态电路 （monostable circuit） 是一种具有稳态和暂态两种工作状态的基本脉冲单元电路。没有外加信号触发时，电路处于稳态。在外加信号触发下，电路从稳态翻转到暂态，并且经过一段时间后，电路又会自动返回到稳态。暂态时间的长短取决于电路本身的参数，而与触发信号作用时间的长短无关。施密特电路中使用到了施密特触发器，施密特触发器也有两个稳定状态，但与一般触发器不同的是，施密特触发器采用电位触发方式，其状态由输入信号电位维持；对于负向递减和正向递增两种不同变化方向的输入信号，施密特触发器有不同的阈值电压。
本发明的进一步技术方案是：所述单稳态施密特电路与PCH寄存器相连。PCH(Platform Controller Hub)是Intel公司的集成南桥。
本发明的进一步技术方案是：所述步骤A包括以下分步骤：
A1. 保持所述单稳态施密特电路的电平为高；
A2. 所述CPU插座和PCIE插槽的在位信号的电平发生改变倒置所述单稳态施密特电路暂时性的输出一个低电平，然后恢复高电平；
A3.所述PCH寄存器中状态位INTRD_DET收到所述单稳态施密特电路发出的低电平后被设置成为1态。
本发明的进一步技术方案是：所述步骤B包括以下分步骤：
B1.所述BIOS检测所述PCH寄存器中状态位INTRD_DET；
B2.若所述PCH寄存器中状态位INTRD_DET为0则不进行操作，若所述PCH寄存器中状态位INTRD_DET为1则进入步骤B3；
B3. 所述BIOS进入SMI中断程序，所述SMI中断程序系所述BIOS读取主板配置信息。
本发明的进一步技术方案是：所述步骤B3后还包括以下步骤B4：所述BIOS暂停系统并显示管理员确认界面。
本发明的进一步技术方案是：步骤C中所述主板配置信息通过IPMI接口传送给所述BMC。IPMI (Intelligent Platform Management Interface) 是智能平台管理接口的缩写，其是一种开放标准的硬件管理接口规格，定义了嵌入式管理子系统进行通信的特定方法。IPMI 信息通过基板管理控制器 BMC（位于 IPMI 规格的硬件组件上）进行交流。使用低级硬件智能管理而不使用操作系统进行管理，用户可以利用IPMI监视服务器的物理健康特征，如温度、电压、风扇工作状态、电源状态等。而且更为重要的是IPMI是一个开放的免费标准，用户无需为使用该标准而支付额外的费用。具有两个主要优点： 首先，此配置允许进行带外服务器管理；其次，操作系统不必负担传输系统状态数据的任务。
本发明的有益效果是：本方法实现了在关机状态下侦测系统硬件变动，可以将平台配置信息及时准确记录在平台本体上，硬件信息变动后，BIOS可以根据需求，灵活多样设置操作路径，可设置为无操作，或者显示警告信息再继续运行，或者暂停系统待管理员确认安全后再继续运行，BMC存储信息进入EEPROM，断电后信息依然能保存不消失，BMC显示界面为研发人员、测试人员、客户提供了统一的信息平台，提高了沟通效率，两次配置差异化显示，能提醒客户硬件变动点。
附图说明
图1是本发明实施例需要的配置电路。
图2是本发明实施例中步骤B和步骤C的流程图。
图3是本发明实施例步骤D的流程图。
具体实施方式
实施例一如图1.2.3.所示。
为了实现本方案，需要硬件模块、BIOS模块和BMC模块共同配合来完成，硬件模块侦测到平台硬件改变以后，以中断的形式，通知BIOS模块，BIOS模块获取当前的系统配置信息，通过IPMI接口将当前的配置信息传递给BMC模块，BMC模块将系统的配置信息存储到EEPROM里面，并在BMC界面显示出来，供用户查看。其中硬件模块主要是指设置在主板上的配置电路。需要说明的是，配置电路的设置方法并不唯一，所有能够实现本方法思路的电路皆在本发明保护范围之内。
图1是本发明实施例提供的硬件配置变动的报警方法中需要的配置电路。如图可见，本实施例中配置电路是将所有CPU插座和PCIE扩展卡插槽的在位信号连接出来,用R1电阻与3.3V RTC(实时时钟)电源和3.3V Sus(待机)电源相连，进行上拉设置。同时连接RTC电源和待机电源的好处是,当系统没有断开AC电源时,由AC电源给电路供电,当AC断开时,由RTC电源给电源供电,这样可以给RTC电池省电。再用R2电阻与地相连，R2要远大于R1，这样在没有CPU和PCIE设备时，在位信号默认是高电平。将在位信号全部连接到单稳态施密特电路上，经过处理，输出信号连接到PCH的INTRUDER#信号上面。当有CPU或者PCIE设备放入插槽时，在位信号会由高电平变成低电平；当有CPU或者PCIE设备移除时，在位信号由低电平变成高电平。单稳态斯密特电路的作用，是所有在位信号输入是高电平或者低电平时，它输出高电平；当有某个在位信号由高电平变成低电平或者由低电平变成高电平时，它暂时性输出一个低电平，然后再恢复为高电平。INTRUDER#由RTC电源供电，当输入低电平时，PCH寄存器中的状态位INTRD_DET会被设置起来，供BIOS使用。
图2是本发明实施例提供的硬件配置变动的报警方法中步骤B和步骤C的流程图。
BIOS程序运行后，首先对寄存器TCO2_CNT中的INTRD_SEL进行设置，设置成当状态位INTRD_DET被置为1时产生SMI中断,然后BIOS程序将检测状态位INTRD_DET是否被设置,如果INTRD_DET被设置为0,说明系统平台并没有CPU、PCIE设备的改变，BIOS继续进行其他操作；如果INTRD_DET被设置为1，说明系统平台已经发生CPU、PCIE设备变动的操作，这将触发SMI中断程序，在中断程序中，BIOS将读取CPU信息、读取DIMM信息、读取PCIE设备信息、读取硬盘信息，然后将全部信息通过IPMI接口传递给BMC模块，传递完成后，BIOS可以选择无操作，也可以选择在显示器上显示硬件变动警告信息，也可以选择暂停系统，待管理员确认安全后继续执行，最后BIOS退出SMI程序返回其他操作。
图3是本发明实施例提供的硬件配置变动的报警方法中步骤D的流程图。
BMC会不停的轮询是否有BIOS发送接收数据命令过来，如果开机过程没有收到接收数据命令，并且BMC没有重新启动，BMC不进行任何操作，若BMC有重新启动，那么BMC要从EEPROM中读取最近两组平台配置信息，将他们显示出来，供参考比较；如果开机过程中收到BIOS传递接收数据的命令，那么BMC将接收到的平台配置信息保存到EEPROM中，然后再读取EEPROM，将最近两组平台配置信息显示出来。在显示这块，最新一次配置变动的地方，可以做特殊标记出来，方便用户及时查阅。
本方法在关机状态下侦测系统硬件变动，包括有电源（S5）和没有电源（G3）两种关机状态。硬件配置变动后，硬件触发中断，由BIOS SMI程序获取平台配置信息，由BMC完成配置信息的存储及差异化显示，三者配合完成将平台配置信息及时准确记录在平台本体上。硬件信息变动后，BIOS可以根据需求，灵活多样设置操作路径，可设置为无操作，或者显示警告信息再继续运行，或者暂停系统待管理员确认安全后再继续运行。BMC存储信息进入EEPROM，断电后信息依然能保存不消失，BMC显示界面为研发人员、测试人员、客户提供了统一的信息平台，提高了沟通效率，两次配置差异化显示，能提醒客户硬件变动点。
以上所述仅为本发明的较佳实施例而已，并不用以限制本发明，凡在本发明的精神和原则之内所作的任何修改、等同替换和改进等，均应包含在本发明的保护范围之内。